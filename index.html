<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Japan Travel App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-bg: #EAF4FC;
            --card-white: #FFFFFF;
            --text-dark: #333;
            --blue-accent: #4A90E2;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            display: flex;
            justify-content: center;
            height: 100vh;
        }

        .mobile-container {
            width: 100%;
            max-width: 400px;
            background-color: var(--primary-bg);
            height: 100%;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .header { padding: 20px; }
        .header h1 { font-size: 20px; margin: 0; color: var(--text-dark); display: flex; align-items: center; }
        .rate-tag { font-size: 12px; color: #666; margin-left: auto; }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 0 20px 100px 20px;
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .content.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- 日期選擇器 --- */
        .date-header-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .day-selector { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; flex: 1; }
        .day-selector::-webkit-scrollbar { display: none; }

        .day-pill {
            background: white; padding: 10px 15px; border-radius: 12px; text-align: center; min-width: 50px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: all 0.2s; border: 2px solid transparent; flex-shrink: 0;
        }
        .day-pill:hover { transform: translateY(-2px); }
        .day-pill.selected { background: var(--blue-accent); color: white; box-shadow: 0 4px 10px rgba(74, 144, 226, 0.4); }
        .day-pill span { display: block; font-size: 12px; margin-bottom: 2px;}
        .day-pill strong { font-size: 18px; }

        .date-setting-btn { background: rgba(255,255,255,0.5); border: none; padding: 8px; border-radius: 50%; cursor: pointer; margin-left: 5px; color: #666; }

        /* --- 彈出視窗 (Modal) --- */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: center; z-index: 999; backdrop-filter: blur(3px);
        }
        .modal-box { background: white; padding: 25px; border-radius: 20px; width: 80%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-box h3 { margin-top: 0; color: var(--blue-accent); }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; font-size: 12px; color: #666; margin-bottom: 5px; }
        .input-group input, .input-group select { 
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; 
        }
        .save-btn { background: var(--blue-accent); color: white; border: none; padding: 12px 30px; border-radius: 30px; font-size: 16px; cursor: pointer; width: 100%; }

        /* --- 天氣卡 (即時) --- */
        .weather-card {
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
            padding: 15px; border-radius: 15px; color: #333; margin-bottom: 15px;
            display: flex; align-items: center; gap: 15px; min-height: 80px;
            transition: all 0.3s ease;
        }
        .weather-location-badge {
            font-size: 10px; background: rgba(255,255,255,0.4); padding: 2px 6px; border-radius: 4px; margin-left: 5px;
        }
        /* Loading 動畫 */
        .skeleton {
            background: rgba(255,255,255,0.3); width: 100%; height: 60px; border-radius: 10px;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 0.3; } 100% { opacity: 0.6; } }

        /* --- 其他卡片 --- */
        .flight-card { background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%); color: white; border-radius: 20px; padding: 20px; margin-bottom: 15px; }
        .flight-time { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 4px; font-size: 12px; margin-bottom: 15px; display: inline-block;}
        .flight-route { display: flex; justify-content: space-between; align-items: center; font-size: 24px; font-weight: bold; margin-bottom: 10px; }
        
        .transport-card, .activity-card {
            background: white; border-radius: 20px; padding: 15px; display: flex; gap: 15px; align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px;
        }
        .icon-box { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .type-transport { background: #EAF4FC; color: #4A90E2; }
        .type-food { background: #FFF4E6; color: #FF9F43; }
        .type-spot { background: #E6FFFA; color: #00B894; }

        .shopping-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .shopping-item { background: white; border-radius: 15px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .item-img { width: 100%; height: 100px; background-color: #eee; border-radius: 10px; margin-bottom: 10px; background-size: cover; background-position: center;}

        .bottom-nav {
            position: absolute; bottom: 20px; left: 20px; right: 20px;
            background: white; border-radius: 30px; height: 60px;
            display: flex; justify-content: space-around; align-items: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); z-index: 100;
        }
        .nav-item { color: #ccc; cursor: pointer; display: flex; flex-direction: column; align-items: center; font-size: 10px; gap: 4px; }
        .nav-item i { font-size: 18px; }
        .nav-item.active { color: var(--blue-accent); }
    </style>
</head>
<body>

    <div class="mobile-container">
        
        <div id="date-modal" class="modal-overlay">
            <div class="modal-box">
                <h3><i class="fa-solid fa-plane-departure"></i> 旅程設定</h3>
                
                <div class="input-group">
                    <label>目的地 (Destination)</label>
                    <select id="destination-select">
                        <option value="Tokyo">東京 (Tokyo)</option>
                        <option value="Osaka">大阪 (Osaka)</option>
                        <option value="Kyoto">京都 (Kyoto)</option>
                        <option value="Sapporo">札幌 (Sapporo)</option>
                        <option value="Fukuoka">福岡 (Fukuoka)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>去程日期 (Start)</label>
                    <input type="date" id="start-date-input">
                </div>
                <div class="input-group">
                    <label>回程日期 (End)</label>
                    <input type="date" id="end-date-input">
                </div>
                
                <button class="save-btn" onclick="generateScheduleDays()">確認並更新</button>
                <div style="margin-top: 10px; font-size: 12px; color: #999; cursor: pointer;" onclick="toggleModal(false)">取消</div>
            </div>
        </div>

        <div class="header">
            <h1 id="page-title">eMenu Trip <i class="fa-solid fa-sort-up" style="font-size:12px; margin-left:5px;"></i></h1>
            <div class="rate-tag">1 JPY ≈ 0.052 HKD</div>
        </div>

        <div class="content active" id="tab-schedule">
            <div class="date-header-row">
                <div class="day-selector" id="day-scroll-container">
                    <div class="day-pill selected"><span>Loading</span><strong>...</strong></div>
                </div>
                <button class="date-setting-btn" onclick="toggleModal(true)">
                    <i class="fa-solid fa-gear"></i>
                </button>
            </div>

            <div id="weather-display" class="weather-card">
                <div class="skeleton"></div>
            </div>

            <h3 style="margin: 10px 0;">行程安排 <span style="float:right; background:#333; color:white; font-size:10px; padding:3px 8px; border-radius:10px;">+ 新增</span></h3>
            <div id="daily-schedule-list"></div>
        </div>

        <div class="content" id="tab-money">
            <h2 style="margin-bottom: 15px;">旅費管理</h2>
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 20px; padding: 25px; text-align: center; margin-bottom: 20px;">
                <div style="font-size: 12px; opacity: 0.8;">總支出 (HKD)</div>
                <div class="total-amount" style="font-size: 36px; font-weight: bold; margin: 10px 0;">$ 1,250</div>
            </div>
            <p style="text-align: center; color: #aaa;">暫無更多支出紀錄</p>
        </div>

        <div class="content" id="tab-shopping">
            <h2 style="margin-bottom: 15px;">購物清單</h2>
            <div class="shopping-grid">
                <div class="shopping-item">
                    <div class="item-img" style="background-color: #ffd1dc;"></div>
                    <div style="font-weight: bold; font-size: 14px;">CEZANNE 101號</div>
                    <div style="color: gray; font-size: 12px;">¥3000</div>
                </div>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchMainTab('tab-schedule', this)"><i class="fa-solid fa-route"></i><span>行程</span></div>
            <div class="nav-item" onclick="switchMainTab('tab-money', this)"><i class="fa-solid fa-map-location-dot"></i><span>地圖</span></div>
            <div class="nav-item" onclick="switchMainTab('tab-money', this)"><i class="fa-solid fa-wallet"></i><span>記帳</span></div>
            <div class="nav-item" onclick="switchMainTab('tab-shopping', this)"><i class="fa-solid fa-bag-shopping"></i><span>購物</span></div>
            <div class="nav-item"><i class="fa-solid fa-circle-info"></i><span>資訊</span></div>
        </div>

    </div>

    <script>
        // === 1. 城市座標資料庫 (可以自己加) ===
        const cityCoordinates = {
            'Hong Kong': { lat: 22.3193, lon: 114.1694, name: '香港' },
            'Tokyo': { lat: 35.6895, lon: 139.6917, name: '東京' },
            'Osaka': { lat: 34.6937, lon: 135.5023, name: '大阪' },
            'Kyoto': { lat: 35.0116, lon: 135.7681, name: '京都' },
            'Sapporo': { lat: 43.0618, lon: 141.3545, name: '札幌' },
            'Fukuoka': { lat: 33.5904, lon: 130.4017, name: '福岡' }
        };

        // 天氣代碼對照表 (WMO Code to Icons)
        function getWeatherIcon(code) {
            // 0: Clear, 1-3: Cloudy, 45-48: Fog, 51-67: Rain, 71-77: Snow, 95: Thunder
            if (code === 0) return { icon: 'fa-sun', color: '#ffbb33', text: '晴朗' };
            if (code >= 1 && code <= 3) return { icon: 'fa-cloud-sun', color: '#ffbb33', text: '多雲' };
            if (code >= 45 && code <= 48) return { icon: 'fa-smog', color: '#ccc', text: '有霧' };
            if (code >= 51 && code <= 67) return { icon: 'fa-cloud-showers-heavy', color: '#74b9ff', text: '有雨' };
            if (code >= 71 && code <= 77) return { icon: 'fa-snowflake', color: '#a29bfe', text: '下雪' };
            if (code >= 80) return { icon: 'fa-cloud-bolt', color: '#636e72', text: '雷雨' };
            return { icon: 'fa-cloud', color: '#aaa', text: '陰天' };
        }

        // 當前設定的旅遊地點 (預設東京)
        let currentTripLocation = 'Tokyo';

        // 行程靜態資料
        const scheduleData = {
            'pre': { list: `<div class="activity-card"><div class="icon-box type-spot"><i class="fa-solid fa-passport"></i></div><div style="flex:1;"><div style="font-weight: bold;">檢查護照</div><div>有效期需超過半年</div></div></div>` },
            'day1': { list: `<div class="flight-card"><span class="flight-time">FLIGHT 09:05</span><div class="flight-route"><span>HKG</span><i class="fa-solid fa-plane flight-icon"></i><span>TYO</span></div><div style="font-size: 12px; opacity:0.8;">HB320 航班前往東京</div></div>` },
            'day2': { list: `<div class="activity-card"><div class="icon-box type-spot"><i class="fa-brands fa-fort-awesome"></i></div><div style="flex:1;"><div style="font-weight: bold;">迪士尼樂園</div><div style="font-size: 12px; color: gray;">全日遊玩</div></div><div style="font-weight:bold;">08:00</div></div>` }
        };

        const emptyStateHTML = `<div style="text-align:center; padding: 40px; color: #aaa;"><i class="fa-solid fa-calendar-plus" style="font-size: 40px; margin-bottom: 10px;"></i><p>這天還沒有行程安排</p><button style="margin-top:10px; padding:5px 15px; border:1px solid #ddd; background:white; border-radius:20px;">+ 規劃行程</button></div>`;

        // === 2. 抓取天氣 API (核心功能) ===
        async function fetchWeather(cityKey) {
            const city = cityCoordinates[cityKey];
            if (!city) return null;

            const displayDiv = document.getElementById('weather-display');
            // 顯示 Loading 狀態
            displayDiv.innerHTML = `<div class="skeleton"></div>`;

            try {
                // 使用 Open-Meteo API
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&current_weather=true`;
                const response = await fetch(url);
                const data = await response.json();
                
                const weather = data.current_weather;
                const info = getWeatherIcon(weather.weathercode);

                // 更新 UI
                displayDiv.innerHTML = `
                    <i class="fa-solid ${info.icon}" style="font-size: 30px; color: ${info.color};"></i>
                    <div>
                        <div style="font-size: 24px; font-weight:bold;">${weather.temperature}°C</div>
                        <div style="font-size: 12px;">
                            ${city.name} - ${info.text} 
                            <span class="weather-location-badge">即時</span>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error("Weather fetch error", error);
                displayDiv.innerHTML = `<div style="color: #666; font-size:12px;">無法載入天氣資訊</div>`;
            }
        }

        // === 3. 生成日期與邏輯控制 ===
        function generateScheduleDays() {
            const startInput = document.getElementById('start-date-input').value;
            const endInput = document.getElementById('end-date-input').value;
            const destination = document.getElementById('destination-select').value;

            if (!startInput || !endInput) { alert("請選擇日期"); return; }

            // 儲存用戶選擇的地點
            currentTripLocation = destination;

            const startDate = new Date(startInput);
            const endDate = new Date(endInput);
            const container = document.getElementById('day-scroll-container');
            
            container.innerHTML = '';

            // 加 "行前"
            const preBtn = document.createElement('div');
            preBtn.className = 'day-pill';
            preBtn.innerHTML = `<span>行前</span><i class="fa-solid fa-clipboard-list"></i>`;
            preBtn.onclick = function() { selectDay('pre', this) };
            container.appendChild(preBtn);

            // 加 Day 1, 2, 3...
            let currentDate = new Date(startDate);
            let dayIndex = 1;

            while (currentDate <= endDate) {
                const dayNum = currentDate.getDate().toString().padStart(2, '0');
                const dayKey = 'day' + dayIndex;

                const btn = document.createElement('div');
                btn.className = 'day-pill';
                btn.dataset.key = dayKey; 
                btn.innerHTML = `<span>Day ${dayIndex}</span><strong>${dayNum}</strong>`;
                btn.onclick = function() { selectDay(this.dataset.key, this) };

                container.appendChild(btn);
                currentDate.setDate(currentDate.getDate() + 1);
                dayIndex++;
            }

            toggleModal(false);
            
            // 自動點擊 Day 1
            const firstDayBtn = container.children[1];
            if (firstDayBtn) firstDayBtn.click();
        }

        function toggleModal(show) {
            const modal = document.getElementById('date-modal');
            modal.style.display = show ? 'flex' : 'none';
            if(show && !document.getElementById('start-date-input').value) {
                const today = new Date();
                document.getElementById('start-date-input').valueAsDate = today;
                document.getElementById('end-date-input').valueAsDate = new Date(today.getTime() + 4*24*60*60*1000);
            }
        }

        // === 4. 切換日期 (包含天氣邏輯) ===
        function selectDay(dayKey, element) {
            // UI 更新
            document.querySelectorAll('.day-pill').forEach(pill => pill.classList.remove('selected'));
            element.classList.add('selected');

            const listContainer = document.getElementById('daily-schedule-list');
            listContainer.style.opacity = '0';

            // --- 天氣邏輯的核心 ---
            if (dayKey === 'pre') {
                // 規則：行前永遠顯示香港
                fetchWeather('Hong Kong');
            } else {
                // 規則：其他日子顯示用戶設定的旅遊地點
                fetchWeather(currentTripLocation);
            }

            // 更新行程列表
            setTimeout(() => {
                const data = scheduleData[dayKey];
                listContainer.innerHTML = data ? data.list : emptyStateHTML;
                listContainer.style.opacity = '1';
                listContainer.style.animation = 'fadeIn 0.4s ease'; 
            }, 100);
        }

        function switchMainTab(tabId, element) {
            document.querySelectorAll('.content').forEach(div => div.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            element.classList.add('active');
        }

        window.onload = function() {
            document.getElementById('start-date-input').value = "2024-03-08";
            document.getElementById('end-date-input').value = "2024-03-11";
            generateScheduleDays(); // 初始化
        };

    </script>
</body>
</html>